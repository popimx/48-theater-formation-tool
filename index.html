<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>劇場公演 フォーメーションツール</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      color: #222;
      max-width: 430px;
      margin-left: auto;
      margin-right: auto;
    }

    h1 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    #controls {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 1rem;
      color: #333;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      margin-bottom: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: #007aff;
      color: white;
    }

    #stage-container {
      position: relative;
      width: 100%;
      aspect-ratio: 6 / 4;
      background-color: black;
      margin: 0 auto 20px;
    }

    .member {
      position: absolute;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: white;
      color: black;
      border: 2px solid black;
      font-size: 14px;
      text-align: center;
      line-height: 36px;
      font-weight: bold;
      cursor: move;
      z-index: 2;
    }

    .seri-line {
      position: absolute;
      width: 2px;
      background-color: white;
      top: 0;
      bottom: 0;
      z-index: 1;
    }

    #position-labels {
      display: flex;
      justify-content: space-between;
      font-size: 1rem;
      margin-top: 8px;
      letter-spacing: 4px;
    }

    #position-labels span {
      display: inline-block;
      padding: 2px 4px;
      background-color: black;
      color: yellow;
      font-weight: bold;
      font-family: monospace;
    }

    #coordinates {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      justify-content: space-between;
    }

    .coordinate-input {
      flex: 1 0 48%;
    }

    canvas {
      display: none;
    }
  </style>
</head>
<body>
  <h1>劇場公演 フォーメーションツール</h1>

  <div id="controls">
    <label for="memberName">メンバー名を追加</label>
    <input type="text" id="memberName" placeholder="例: 山田花子" />
    <button onclick="addMember()">追加</button>
    <button onclick="saveImage()">画像として保存</button>
  </div>

  <div id="stage-container">
    <div class="seri-line" style="left: 25%;"></div>
    <div class="seri-line" style="left: 50%;"></div>
    <div class="seri-line" style="left: 75%;"></div>
  </div>

  <div id="position-labels">
    <span>6</span><span>5</span><span>4</span><span>3</span><span>2</span><span>1</span>
    <span>0</span>
    <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span>
  </div>

  <div id="coordinates"></div>

  <canvas id="canvas"></canvas>

  <script>
    const stage = document.getElementById("stage-container");
    const coordsContainer = document.getElementById("coordinates");

    function addMember() {
      const nameInput = document.getElementById("memberName");
      const name = nameInput.value.trim();
      if (!name) return;

      const member = document.createElement("div");
      member.className = "member";
      member.textContent = name;
      member.style.left = "50%";
      member.style.top = "50%";
      makeDraggable(member);
      stage.appendChild(member);

      const coordBlock = document.createElement("div");
      coordBlock.className = "coordinate-input";
      coordBlock.innerHTML = `
        <label>${name}</label>
        X: <input type="number" value="50" data-member="${name}" data-axis="x" />
        Y: <input type="number" value="50" data-member="${name}" data-axis="y" />
      `;
      coordsContainer.appendChild(coordBlock);

      const inputs = coordBlock.querySelectorAll("input");
      inputs.forEach(input => {
        input.addEventListener("input", () => {
          const axis = input.dataset.axis;
          const value = input.value + "%";
          if (axis === "x") member.style.left = value;
          else member.style.top = value;
        });
      });

      nameInput.value = "";
    }

    function makeDraggable(el) {
      let offsetX = 0, offsetY = 0;
      el.addEventListener("mousedown", startDrag);
      el.addEventListener("touchstart", startDrag);

      function startDrag(e) {
        e.preventDefault();
        const startX = e.clientX || e.touches[0].clientX;
        const startY = e.clientY || e.touches[0].clientY;
        const rect = el.getBoundingClientRect();
        const stageRect = stage.getBoundingClientRect();
        offsetX = startX - rect.left;
        offsetY = startY - rect.top;

        function dragMove(eMove) {
          const moveX = eMove.clientX || eMove.touches[0].clientX;
          const moveY = eMove.clientY || eMove.touches[0].clientY;
          const x = ((moveX - offsetX - stageRect.left) / stageRect.width) * 100;
          const y = ((moveY - offsetY - stageRect.top) / stageRect.height) * 100;
          el.style.left = x + "%";
          el.style.top = y + "%";

          // 座標反映
          const name = el.textContent;
          const inputs = document.querySelectorAll(`input[data-member="${name}"]`);
          inputs.forEach(input => {
            if (input.dataset.axis === "x") input.value = x.toFixed(1);
            else input.value = y.toFixed(1);
          });
        }

        function stopDrag() {
          document.removeEventListener("mousemove", dragMove);
          document.removeEventListener("mouseup", stopDrag);
          document.removeEventListener("touchmove", dragMove);
          document.removeEventListener("touchend", stopDrag);
        }

        document.addEventListener("mousemove", dragMove);
        document.addEventListener("mouseup", stopDrag);
        document.addEventListener("touchmove", dragMove);
        document.addEventListener("touchend", stopDrag);
      }
    }

    function saveImage() {
      const canvas = document.getElementById("canvas");
      const stageRect = stage.getBoundingClientRect();
      const totalHeight = stage.offsetHeight + document.getElementById("position-labels").offsetHeight;

      canvas.width = stage.offsetWidth;
      canvas.height = totalHeight;
      const ctx = canvas.getContext("2d");

      // 背景色
      ctx.fillStyle = "#f9f9f9";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ステージ背景
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, stage.offsetWidth, stage.offsetHeight);

      // セリ
      ctx.fillStyle = "#fff";
      [0.25, 0.5, 0.75].forEach(p => {
        const x = stage.offsetWidth * p;
        ctx.fillRect(x, 0, 2, stage.offsetHeight);
      });

      // メンバー
      document.querySelectorAll(".member").forEach(member => {
        const rect = member.getBoundingClientRect();
        const left = rect.left - stageRect.left;
        const top = rect.top - stageRect.top;
        ctx.beginPath();
        ctx.arc(left + 18, top + 18, 18, 0, Math.PI * 2);
        ctx.fillStyle = "white";
        ctx.fill();
        ctx.strokeStyle = "black";
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.fillStyle = "black";
        ctx.font = "bold 12px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(member.textContent, left + 18, top + 18);
      });

      // 立ち位置番号
      const labels = ["6","5","4","3","2","1","0","1","2","3","4","5","6"];
      const spanWidth = canvas.width / 13;
      labels.forEach((label, i) => {
        const x = i * spanWidth;
        ctx.fillStyle = "black";
        ctx.fillRect(x + 2, stage.offsetHeight, spanWidth - 4, 20);
        ctx.fillStyle = "yellow";
        ctx.font = "bold 14px monospace";
        ctx.textAlign = "center";
        ctx.fillText(label, x + spanWidth / 2, stage.offsetHeight + 14);
      });

      // 保存
      const link = document.createElement("a");
      link.download = "stage_formation.png";
      link.href = canvas.toDataURL();
      link.click();
    }
  </script>
</body>
</html>