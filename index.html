<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>劇場公演 フォーメーションツール</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background-color: #fff;
      color: #000;
    }
    .container {
      max-width: 390px;
      margin: 0 auto;
      padding: 10px;
    }
    .controls {
      margin-bottom: 10px;
    }
    .controls input {
      width: 100%;
      margin-bottom: 5px;
      font-size: 16px;
    }
    .stage-wrapper {
      position: relative;
      background: #ddd;
      padding: 10px 0 0 0;
    }
    .stage {
      position: relative;
      width: 100%;
      aspect-ratio: 13 / 6;
      background: #666;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(3, 1fr);
      box-sizing: border-box;
    }
    .vertical-line, .horizontal-line {
      position: absolute;
      background: white;
      z-index: 0;
    }
    .vertical-line {
      width: 2px;
      top: 0;
      bottom: 0;
    }
    .horizontal-line {
      height: 2px;
      left: 0;
      right: 0;
    }
    .position-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 2px;
    }
    .position-label {
      background: #000;
      color: yellow;
      width: 24px;
      height: 24px;
      font-size: 14px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
    }
    .member {
      position: absolute;
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 13px;
      text-align: center;
      cursor: move;
      z-index: 2;
    }
    .coords {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }
    .hide-during-save {
      display: block;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="controls hide-during-save">
      <input type="text" id="memberName" placeholder="メンバー名を追加">
      <button onclick="addMember()">追加</button>
      <button onclick="saveImage()">画像として保存</button>
    </div>

    <div class="stage-wrapper">
      <div class="stage" id="stage">
        <!-- 線は JS で追加 -->
      </div>
      <div class="position-labels" id="positionLabels"></div>
    </div>
  </div>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    const stage = document.getElementById('stage');
    const labelsContainer = document.getElementById('positionLabels');
    const labelValues = ["6", "5", "4", "3", "2", "1", "0", "1", "2", "3", "4", "5", "6"];
    labelsContainer.innerHTML = '';
    labelValues.forEach(val => {
      const div = document.createElement('div');
      div.className = 'position-label';
      div.textContent = val;
      labelsContainer.appendChild(div);
    });

    // セリの縦線（3番・0番・3番）
    const addVerticalLines = () => {
      const stageWidth = stage.clientWidth;
      const positions = [3, 6, 9]; // index in labelValues (left 3, 0, right 3)
      positions.forEach(idx => {
        const left = stageWidth * (idx / 13);
        const line = document.createElement('div');
        line.className = 'vertical-line';
        line.style.left = `${left}px`;
        stage.appendChild(line);
      });
    };

    // セリの横線（12区画）
    const addHorizontalLines = () => {
      const stageHeight = stage.clientHeight;
      [1, 2].forEach(i => {
        const top = stageHeight * (i / 3);
        const line = document.createElement('div');
        line.className = 'horizontal-line';
        line.style.top = `${top}px`;
        stage.appendChild(line);
      });
    };

    addVerticalLines();
    addHorizontalLines();

    function addMember() {
      const name = document.getElementById('memberName').value.trim();
      if (!name) return;
      const div = document.createElement('div');
      div.className = 'member';
      div.textContent = name;
      div.style.left = '10px';
      div.style.top = '10px';
      makeDraggable(div);
      stage.appendChild(div);
      document.getElementById('memberName').value = '';
    }

    function makeDraggable(el) {
      let offsetX = 0, offsetY = 0;
      el.onmousedown = function(e) {
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
        document.onmousemove = function(e) {
          const x = e.clientX - offsetX;
          const y = e.clientY - offsetY;
          el.style.left = `${x}px`;
          el.style.top = `${y}px`;
        };
        document.onmouseup = function() {
          document.onmousemove = null;
          document.onmouseup = null;
        };
      };
    }

    function saveImage() {
      document.querySelectorAll('.hide-during-save').forEach(e => e.classList.add('hidden'));
      html2canvas(document.querySelector('.stage-wrapper')).then(canvas => {
        const link = document.createElement('a');
        link.download = 'stage_formation.png';
        link.href = canvas.toDataURL();
        link.click();
        document.querySelectorAll('.hide-during-save').forEach(e => e.classList.remove('hidden'));
      });
    }
  </script>
</body>
</html>